services:
  crowdsec:
    container_name: ${SERVICE:-crowdsec}
    image: crowdsecurity/crowdsec:${VERSION:-latest}
    restart: always
    environment: 
      # https://hub.crowdsec.net/author/crowdsecurity/collections/traefik
      COLLECTIONS: ${COLLECTIONS:-crowdsecurity/traefik}
      GID: ${GID-1000}
    volumes:
      - config:/etc/crowdsec
      - data:/var/lib/crowdsec/data
      # logs
      - traefik_logs:/var/log/traefik:ro
      # Timesync
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - traefik
    labels:
      - traefik.enable=false

  dashboard:
    container_name: ${SERVICE:-crowdsec}-dashboard
    image: metabase/metabase:${VERSION:-latest}
    restart: unless-stopped
    ports: 
      - ${INT_PORT:-0}:3000
    environment: 
      - MB_DB_FILE=/metabase.db
    volumes:
      - ${DB_PATH}:/metabase.db
      # Timesync
      - /etc/localtime:/etc/localtime:ro
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.http.routers.${SERVICE}.rule=Host(`${DOMAIN}`)
      - traefik.http.routers.${SERVICE}.entrypoints=https
      - traefik.http.routers.${SERVICE}.tls.certresolver=letsencrypt
      - traefik.http.services.${SERVICE}.loadbalancer.server.port=${PORT}
      - traefik.docker.network=traefik

volumes:
  config:
    driver: local
  data:
    driver: local
  traefik_logs:
    external: true

networks:
  traefik:
    external: true
